<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>λ³΄μ• QR μ½”λ“ μƒμ„±κΈ° (μµμ… μ•”νΈν™”)</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<main>
  <h2>QR μ½”λ“ μƒμ„±</h2>
  <label for="inputText">λ‚΄μ© μ…λ ¥ (ν•„μ)</label>
  <textarea id="inputText" rows="4" placeholder="λ‚΄μ©μ„ μ…λ ¥ν•μ„Έμ”"></textarea>

  <div class="flex-row">
    <div class="form-section">
      <label for="inputAuthor" style="margin: 0;">μ‘μ„±μ (μ„ νƒ)</label>
      <input type="text" id="inputAuthor" placeholder="μ‘μ„±μ" />

      <label>λ§λ£ μ‹κ°„</label>
      <select id="expireUnit" onchange="handleExpireUnitChange()">
        <option value="none">μ—†μ</option>
        <option value="minute">λ¶„</option>
        <option value="hour">μ‹κ°„</option>
        <option value="day">μΌ</option>
      </select>
      <input type="number" id="expireValue" placeholder="μ‹κ°„ μ…λ ¥ (μ«μ)" disabled />

      <label for="inputPassword">λΉ„λ°€λ²νΈ (μ„ νƒ)</label>
      <input type="password" id="inputPassword" placeholder="λΉ„λ°€λ²νΈκ°€ μ—†μΌλ©΄ μ•”νΈν™”λμ§€ μ•μµλ‹λ‹¤." />

      <button id="generateBtn" onclick="generateSecureQR()">
        <span id="generateBtnText">β… QR μƒμ„±ν•κΈ°</span>
        <div id="generateSpinner" class="spinner"></div>
      </button>

      <button onclick="downloadQR()">π’Ύ QR λ‹¤μ΄λ΅λ“</button>
    </div>

    <div class="qr-preview">
      <div id="qrcode"></div>
    </div>
  </div>

  <h2>QR μ΄λ―Έμ§€ ν•΄μ„</h2>
  <div class="flex-row">
    <div class="form-section">
      <input type="file" style="margin: 0;" accept="image/*" onchange="handleFile(event)" />
      <input type="password" id="decryptPassword" placeholder="λΉ„λ°€λ²νΈ(μ—†μΌλ©΄ ν‰λ¬Έ ν•΄μ„)" style="margin-top:1rem;" />

      <button id="decryptBtn" onclick="tryDecrypt()">
        <span id="decryptBtnText">π” ν•΄μ„ μ‹λ„</span>
        <div id="decryptSpinner" class="spinner"></div>
      </button>

      <button onclick="copyDecryptedText()">π“‹ λ‚΄μ© λ³µμ‚¬</button>
      <div id="decodeResult" class="result">νμΌμ„ μ—…λ΅λ“ν•΄μ£Όμ„Έμ”</div>
      <div id="copyMsg" class="message"></div>
    </div>

    <div class="qr-preview">
      <img id="previewImage" style="display: none;" />
    </div>
  </div>

  <div id="finalOutput"></div>
  <canvas id="canvas" style="display:none;"></canvas>
</main>

<script>
  let scannedData = "";
  let lastDecrypted = "";
  let qrRecognized = false;

  function handleExpireUnitChange() {
    const unit = document.getElementById("expireUnit").value;
    document.getElementById("expireValue").disabled = (unit === 'none');
  }

  function getExpireInMs() {
    const unit = document.getElementById("expireUnit").value;
    const value = parseInt(document.getElementById("expireValue").value);
    if (unit === 'none' || !value || value <= 0) return null;
    if (unit === 'minute') return value * 60000;
    if (unit === 'hour') return value * 3600000;
    if (unit === 'day') return value * 86400000;
    return null;
  }

  function generateSecureQR() {
    const generateBtn = document.getElementById("generateBtn");
    const generateBtnText = document.getElementById("generateBtnText");
    const generateSpinner = document.getElementById("generateSpinner");

    // λ΅λ”©
    generateSpinner.style.display = "inline-block";
    generateBtn.disabled = true;
    generateBtnText.innerText = "π”„ μƒμ„± μ¤‘...";

    setTimeout(() => {
      const text = document.getElementById("inputText").value.trim();
      const password = document.getElementById("inputPassword").value.trim();
      const author = document.getElementById("inputAuthor").value.trim();
      const expiresIn = getExpireInMs();

      if (!text) {
        alert("λ‚΄μ©μ€ ν•„μμ…λ‹λ‹¤.");
        generateSpinner.style.display = "none";
        generateBtn.disabled = false;
        generateBtnText.innerText = "β… QR μƒμ„±";
        return;
      }

      // === μ•”νΈν™” μ—¬λ¶€ κ²°μ • ===
      let dataObject = {
        encryption: false,
        text,
        author,
        createdAt: Date.now(),
        expiresIn
      };

      if (password) {
        dataObject.encryption = true;
        // μ•”νΈν™” μ§„ν–‰
        const salt = CryptoJS.lib.WordArray.random(128 / 8);
        const key = CryptoJS.PBKDF2(password, salt, {
          keySize: 256 / 32,
          iterations: 50000
        });
        const iv = CryptoJS.lib.WordArray.random(128 / 8);
        const encrypted = CryptoJS.AES.encrypt(JSON.stringify(dataObject), key, { iv });

        // μµμΆ… result
        dataObject = {
          iv: iv.toString(CryptoJS.enc.Base64),
          salt: salt.toString(CryptoJS.enc.Base64),
          data: encrypted.toString(),
          encryption: true
        };
      }

      // QR μƒμ„±
      const qrContainer = document.getElementById("qrcode");
      qrContainer.innerHTML = "";

      const rawString = JSON.stringify(dataObject);
      const encoded = btoa(rawString);

      new QRCode(qrContainer, {
        text: encoded,
        width: 320,
        height: 320
      });

      // λ΅λ”© ν•΄μ 
      generateSpinner.style.display = "none";
      generateBtn.disabled = false;
      generateBtnText.innerText = "β… QR μƒμ„±";
    }, 300); // 0.3μ΄ λ΅λ”© ν‘μ‹
  }

  function downloadQR() {
    const img = document.querySelector("#qrcode img");
    if (!img) {
      alert("QR μ½”λ“λ¥Ό λ¨Όμ € μƒμ„±ν•μ„Έμ”.");
      return;
    }
    const link = document.createElement("a");
    link.href = img.src;
    link.download = "secure_qr.png";
    link.click();
  }

  function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.getElementById("previewImage");
      img.src = e.target.result;
      img.style.display = "block";

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const image = new Image();
      image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          scannedData = code.data;
          qrRecognized = true;
          showMessage("QR μΈμ‹ μ™„λ£. λΉ„λ°€λ²νΈκ°€ μμΌλ©΄ μ…λ ¥ ν›„ ν•΄μ„μ„ μ‹λ„ν•μ„Έμ”.");
        } else {
          qrRecognized = false;
          showMessage("QR μΈμ‹ μ‹¤ν¨. λ‹¤λ¥Έ νμΌμ„ μ‹λ„ν•΄μ£Όμ„Έμ”.");
        }
      };
      image.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function tryDecrypt() {
    const decryptBtn = document.getElementById("decryptBtn");
    const decryptBtnText = document.getElementById("decryptBtnText");
    const decryptSpinner = document.getElementById("decryptSpinner");

    // λ΅λ”© ν‘μ‹
    decryptSpinner.style.display = "inline-block";
    decryptBtn.disabled = true;
    decryptBtnText.innerText = "π”„ ν•΄μ„ μ¤‘...";

    setTimeout(() => {
      if (!qrRecognized) {
        showMessage("QR μ½”λ“κ°€ μΈμ‹λμ§€ μ•μ•μµλ‹λ‹¤. μ΄λ―Έμ§€λ¥Ό μ—…λ΅λ“ν•΄μ£Όμ„Έμ”.");
        resetDecryptUI();
        return;
      }
      const password = document.getElementById("decryptPassword").value.trim();

      try {
        // base64 β†’ json νμ‹±
        const parsed = JSON.parse(atob(scannedData));
        if (parsed.encryption) {
          // μ•”νΈν™” QR
          if (!password) {
            showMessage("μ΄ QRμ€ μ•”νΈν™”λμ—μµλ‹λ‹¤. λΉ„λ°€λ²νΈλ¥Ό μ…λ ¥ν•μ„Έμ”.");
            resetDecryptUI();
            return;
          }
          // λ³µνΈν™”
          const salt = CryptoJS.enc.Base64.parse(parsed.salt);
          const iv = CryptoJS.enc.Base64.parse(parsed.iv);
          const key = CryptoJS.PBKDF2(password, salt, {
            keySize: 256 / 32,
            iterations: 50000
          });
          const decrypted = CryptoJS.AES.decrypt(parsed.data, key, { iv });
          const resultText = decrypted.toString(CryptoJS.enc.Utf8);
          if (!resultText) throw new Error("λ³µνΈν™” μ‹¤ν¨");

          const realData = JSON.parse(resultText);
          // λ§λ£μ—¬λ¶€
          if (realData.expiresIn && Date.now() > realData.createdAt + realData.expiresIn) {
            showMessage("β° QR μ½”λ“κ°€ λ§λ£λμ—μµλ‹λ‹¤.");
          } else {
            lastDecrypted = realData.text;
            showMessage("β… λ³µνΈν™” μ„±κ³µ!");
            renderDecryptedOutput(realData.author, realData.text);
          }
        } else {
          // ν‰λ¬Έ
          if (parsed.expiresIn && Date.now() > parsed.createdAt + parsed.expiresIn) {
            showMessage("β° QR μ½”λ“κ°€ λ§λ£λμ—μµλ‹λ‹¤.");
          } else {
            lastDecrypted = parsed.text;
            showMessage("β… ν•΄μ„ μ„±κ³µ(μ•”νΈν™” μ—†μ)!");
            renderDecryptedOutput(parsed.author, parsed.text);
          }
        }

      } catch (e) {
        console.error(e);
        showMessage("β λ³µνΈν™” μ‹¤ν¨: λΉ„λ°€λ²νΈκ°€ ν‹€λ Έκ±°λ‚ QR λ‚΄μ©μ΄ μλ»λμ—μµλ‹λ‹¤.");
      }
      resetDecryptUI();
    }, 300);
  }

  function renderDecryptedOutput(author, text) {
    // μ‘μ„±μ λ¨Όμ €, λ‚΄μ©μ€ μ•„λ. μ‘μ„±μκ°€ μ—†μΌλ©΄ μƒλµ
    let html = `<div class="final-wrapper">`;
    if (author) {
      html += `<div class="final-author">μ‘μ„±μ: ${author}</div>`;
    }
    html += `<div class="final-text">λ‚΄μ©: ${text}</div>`;
    html += `</div>`;
    document.getElementById("finalOutput").innerHTML = html;
  }

  function resetDecryptUI() {
    const decryptBtn = document.getElementById("decryptBtn");
    const decryptBtnText = document.getElementById("decryptBtnText");
    const decryptSpinner = document.getElementById("decryptSpinner");

    decryptSpinner.style.display = "none";
    decryptBtn.disabled = false;
    decryptBtnText.innerText = "π” ν•΄μ„ μ‹λ„";
  }

  function showMessage(msg) {
    const target = document.getElementById("decodeResult");
    target.innerHTML = "";
    let i = 0;
    const interval = setInterval(() => {
      target.innerHTML += msg[i];
      i++;
      if (i >= msg.length) clearInterval(interval);
    }, 20);
  }

  function copyDecryptedText() {
    if (!lastDecrypted) return;
    navigator.clipboard.writeText(lastDecrypted).then(() => {
      document.getElementById("copyMsg").textContent = "λ³µνΈν™”λ ν…μ¤νΈκ°€ λ³µμ‚¬λμ—μµλ‹λ‹¤.";
      setTimeout(() => {
        document.getElementById("copyMsg").textContent = "";
      }, 2000);
    });
  }
</script>
</body>
</html>
